<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>Jython Annotator</title>
    <link rel="stylesheet" href="codemirror.css" type="text/css">
    <link rel="stylesheet" href="index.css" type="text/css">
    <script src="util.js" type="text/javascript"></script>
  </head>
  <body>
    <details><summary> The Jython Annotator allows annotations to be generated by
        executing a program or expression written in Python. </summary> 
      
      <p>A full script is given the whole Annotation Graph, which it can traverse,
        process, and add annotations to.</p>

      <details><summary>An Annotation Graph is a directed graph where labelled Annotations
          are arcs between Anchors, which are the graph nodes represting moments in
          time. </summary>

        <p>There are three types of object that the script can access:</p>

        <dl>
          <dt><a target="javadoc"
            href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Graph.html">Graph</a></dt> <dd>
            This represents the transcript as a whole, accessible via a built-in variable
            called <var>transcript</var>, and is a directed graph consisting of a
            collection of:</dd> 
          <dt><a target="javadoc" href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Annotation.html">Annotations</a></dt> <dd> These are 'arcs' in the graph, and represent all the
            text in the transcript, including speaker turns, utterances, word tokens, and
            any annotations that might be present; lemma, part of speech, etc. - along
            with:</dd> 
          <dt><a target="javadoc" href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Anchor.html">Anchors</a></dt> <dd> These are 'nodes' in the graph which represent points in
            time.</dd> 
        </dl>

        <p>Each Annotation has the following attributes:</p>

        <dl>          
          <dt>layerId</dt> <dd> The layer it's on. </dd>
          <dt>label</dt> <dd> The text of the annotation - this is the word orthography, or
            POS label, or speaker name, or whatever text is associated with the
            annotation, depending on what layer it's on. </dd>
          <dt>start</dt> <dd>The start anchor representing the start time of the word, or
            utterance, or turn, or whatever it is. It has an 'offset' attribute
            representing the time in seconds since the start of the transcript. </dd>
          <dt>end</dt> <dd>The end anchor representing the end time of the annotation,
            having an 'offset'. </dd>
        </dl>

        <p> In addition to these attributes, each Annotation has a number of functions or
          'methods' that can be executed. The one you're most likely to use is
          <a target="javadoc" href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Annotation.html#createTag(java.lang.String,java.lang.String)">createTag(layerId, label)</a>
          which tags the given annotation with a label on another
          layer. Other methods include: </p>
        
        <dl>
          <dt><a target="javadoc" href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Annotation.html#all(java.lang.String)">all(layerId)</a></dt> <dd>- gets a list of all annotations on another layer that
            relate to this annotation - this is useful when, for example, you want all the words
            in a speaker turn, or all the segments in a word</dd> 
          <dt><a target="javadoc" href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Annotation.html#first(java.lang.String)">first(layerId)</a></dt> <dd>- gets the first element of the list returned by all
            - this is useful when you're sure that there's only one annotation (e.g. the
            POS tag of a word token) and dealing with a one-item list would be annoying.</dd> 
          <dt><a target="javadoc" href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Annotation.html#getDuration()">getDuration()</a></dt> <dd>- the duration of the annotation - i.e. end.offset -
            start.offset</dd> 
          <dt><a target="javadoc" href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Annotation.html#getNext()">getNext()</a></dt> <dd>- the previous annotation on the same layer with the same parent - e.g. word.getNext() accesses the next word in the same turn, if any. Similarly there's a <a target="javadoc" href="https://nzilbb.github.io/ag/apidocs/nzilbb/ag/Annotation.html#getPrevious()">getPrevious()</a> method.</dd> 
        </dl>
      </details>
      
      <p> The script is executed for each transcript, with a variable
        called <var>transcript</var> which stores the transcript's Annotation
        Graph. <var>transcript</var> can be traversed to inspect annotations, and can have
        annotations added to it (on this layer only), which will be saved back to
        LaBB-CAT&#39;s annotation store when the script completes. </p>
      
      <p> The <var>transcript</var> graph is populated with annotations from the layers
        that are referring to in script.</p>
      
      <p> If your script creates new annotations on a layer that doesn't exist yet,
        (e.g. by using <code><var>annotation</var>.createTag("layer", <var>label</var>)</code>),
        then the mentioned layer will be automatically created as an interval span
        layer. If you want another type of layer (e.g. a word tag layer), be sure
        to click the <q>New Layer</q> button, fill in the details that appear, and
        click the <q>Define Layer</q> button, to ensure the right type of layer is
        created. </p>
      
      <p> The script might look something like the following, which tags each word with its
        length, on a layer called "length":</p> 
      <pre>
<span style="color:#8b4513;"># for each turn in the transcript</span>
<span style="color:#800080;">for</span> turn <span style="color:#800080;">in</span> transcript.all(&quot;turn&quot;):
&nbsp; <span style="color:#800080;">if</span> annotator.cancelling <span style="color:#800080;">break</span> <span style="color:#8b4513;"># cancelled by the user</span>
&nbsp; <span style="color:#8b4513;"># for each word</span>
&nbsp; <span style="color:#800080;">for</span> word <span style="color:#800080;">in</span> turn.all(&quot;word&quot;):
&nbsp;&nbsp;&nbsp; <span style="color:#8b4513;"># tag the word with it's length</span>
&nbsp;&nbsp;&nbsp; word.createTag("length", &quot;length: &quot; + str(len(word.label))
&nbsp;&nbsp;&nbsp; log("Tagged word: " + word.label)
            </pre>

    </details>
    
    <hr>
    
    <form method="POST" action="setTaskParameters" id="form">

      <div id="loadControls">
        <label> Load script from file <input id="loadLocalScript" type="file"></label>
      </div>
      <div id="saveControls">
        <button class="form_button" id="saveLocalScript">Save script to file</button> 
      </div>
      <div id="newLayer">
        <button id="newLayerButton"
                title="Create a new annotation layer for output"> New Layer </button>
        <div id="addingLayer" style="display: none;">
          <label>New Layer Name:
            <input id="newLayerId" type="text" title="ID for the new output layer"></label>
          <label>Type:
            <select id="newLayerParentId" title="What kind of layer is it?">
              <option id="rootParent">Span Layer</option>
              <option id="turnParent">Phrase Layer</option>
              <option id="wordParent">Word Layer</option>
            </select>
          </label>
          <label>Alignment:
            <select id="newLayerAlignment"
                    title="Does the layer mark out intervals or instants?">
              <option value="0" id="newLayerAlignment0">Not aligned</option>
              <option value="1">Points</option>
              <option value="2">Intervals</option>
            </select>
          </label>
          <button id="addLayerButton" title="Define the new layer"> Define Layer </button>
        </div><!--addingLayer-->
      </div><!--newLayer-->
      <div id="scriptDiv">
        <fieldset><legend> Script </legend>
          <textarea name="script" id="script"></textarea>
        </fieldset>
      </div><!-- scriptDiv -->
      
      <div class="controls"><input type="submit" value="Set Parameters"></div>
    </form>
    
    <footer><div> Jython Annotator <small id="version"></small> </div></footer>
    <script src="codemirror.js" type="text/javascript"></script>
    <script src="python.js" type="text/javascript"></script>
    <script src="index.js" type="text/javascript"></script>
  </body>
</html>
