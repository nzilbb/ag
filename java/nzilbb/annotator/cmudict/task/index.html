<!DOCTYPE html>
<html>
  <head>
    <title> CMU Pronouncing Dictionary </title>
    <link rel="stylesheet" href="index.css" type="text/css">
    <script src="index.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>CMU Pronouncing Dictionary</h1>
    <h2>Task: <span id="task"></span></h2>

    <p> This annotator tags words with their pronunciations according to the
      <a href="http://www.speech.cs.cmu.edu/cgi-bin/cmudict">CMU Pronouncing dictionary</a>,
      a machine-readable pronunciation dictionary for North American English that contains
      over 125,000 words and their transcriptions. </p> 

    <form method="POST" action="setTaskParameters">
      <div class="field" title="Input layer from which words come">
        <label for="tokenLayerId"> Token Layer </label>
        <span><select id="tokenLayerId" name="tokenLayerId" required></select></span>
      </div>
      <div class="field" title="Transcript attribute for overall language">
        <label for="transcriptLanguageLayerId"> Transcript Language Attribute </label>
        <span>
          <select id="transcriptLanguageLayerId" name="transcriptLanguageLayerId">
            <option value="">[none]</option>
          </select>
        </span>
      </div>
      <div class="field" title="Layer for annotating phrases in a different language">
        <label for="phraseLanguageLayerId"> Phrase Language Layer </label>
        <span>
          <select id="phraseLanguageLayerId" name="phraseLanguageLayerId">
            <option value="">[none]</option>
          </select>
        </span>
      </div>
      <div class="field" title="Output layer on which pronunciation annotations are added">
        <label for="pronunciationLayerId"> Pronunciation Layer </label>
        <span>
          <select id="pronunciationLayerId" name="pronunciationLayerId" required
                  onChange="changedLayer(this);">
            <option disabled>[select layer]</option> <!-- force choice the first time -->
            <option>[add new layer]</option>         <!-- allow adding a new layer -->
          </select>
        </span>
      </div>
      <div class="field"
           title="If there are multiple pronunciations for the word, use only the first one.">
        <label for="firstVariantOnly"> First variant only </label>
        <span><input id="firstVariantOnly" name="firstVariantOnly" type="checkbox"></span>
      </div>
      <div class="controls"><input type="submit" value="Finished"></div>
    </form>
    <script type="text/javascript">
      function get(path, onload) { // make a GET request of the annotator
          var request = new XMLHttpRequest();
          request.open("GET", path);
          request.addEventListener("load", onload, false);
          request.send();
      }

      // show annotator version
      getText("getVersion", function(e) {
          document.getElementById("version").innerHTML = this.responseText;
      });
      
      // show the task ID
      document.getElementById("task").innerHTML = window.location.search.substring(1);
      
      // first, get the layer schema
      var schema = null;
      getJSON("getSchema", function(e) {
          schema = JSON.parse(this.responseText);
              
          // populate layer input select options...          
          var tokenLayerId = document.getElementById("tokenLayerId");
          addLayerOptions(
              tokenLayerId, schema,
              // this is a function that takes a layer and returns true for the ones we want
              layer => layer.id == schema.wordLayerId
                  || (layer.parentId == schema.wordLayerId && layer.alignment == 0));
          // default value:
          tokenLayerId.value = schema.wordLayerId;

          // populate the language layers...
          
          var transcriptLanguageLayerId = document.getElementById("transcriptLanguageLayerId");
          addLayerOptions(
              transcriptLanguageLayerId, schema,
              layer => layer.parentId == schema.root.id && layer.alignment == 0
                  && /.*lang.*/.test(layer.id));
          // select the first one by default
          transcriptLanguageLayerId.selectedIndex = 1;
          
          var phraseLanguageLayerId = document.getElementById("phraseLanguageLayerId");
          addLayerOptions(
              phraseLanguageLayerId, schema,
              layer => layer.parentId == schema.turnLayerId && layer.alignment == 2
                  && /.*lang.*/.test(layer.id));
          // select the first one by default
          phraseLanguageLayerId.selectedIndex = 1;
          
          // populate layer output select options...          
          var pronunciationLayerId = document.getElementById("pronunciationLayerId");
          addLayerOptions(
              pronunciationLayerId, schema,
              layer => layer.parentId == schema.wordLayerId && layer.alignment == 0);
          pronunciationLayerId.selectedIndex = 0;
          
          // GET request to getTaskParameters retrieves the current task parameters, if any
          getText( "getTaskParameters"+window.location.search, function(e) {
              var parameters = new URLSearchParams(this.responseText);
              
              // set initial values of properties in the form above
              // (this assumes bean property names match input id's in the form above)
              for (const [key, value] of parameters) {
                  document.getElementById(key).value = value;
              }
              // set the checkbox
              document.getElementById("firstVariantOnly").checked
                  = parameters.get("firstVariantOnly");
          });
      });
      
      // this function detects when the user selects [add new layer]:
      function changedLayer(select) {
          if (select.value == "[add new layer]") {
              var newLayer = prompt("Please enter the new layer ID", "phonemes");
              if (newLayer) { // they didn't cancel
                  // check there's not already a layer with that name
                  for (var l in schema.layers) {
                      var layer = schema.layers[l];
                      if (layer.id == newLayer) {
                          alert("A layer called "+newLayer+" already exists");
                          select.selectedIndex = 0;
                          return;
                      }
                  } // next layer
                  // add the layer to the list
                  var layerOption = document.createElement("option");
                  layerOption.appendChild(document.createTextNode(newLayer));
                  select.appendChild(layerOption);
                  // select it
                  select.selectedIndex = select.children.length - 1;
              }
          }
      }
    </script>
    
    <hr>
    

    <footer><div> CMU Pronouncing Dictionary <small id="version"></small> </div></footer>
  </body>
</html>
